---
title: "jest ã§éåŒæœŸé–¢æ•°ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã¨ãã®æ³¨æ„ç‚¹"
emoji: "ğŸ§ª"
type: "tech"
topics: ["JavaScript","nodejs","éåŒæœŸå‡¦ç†","Jest"]
published: true
published_at: 2018-11-08 02:20
---
  
ä¸é©åˆ‡ãªæ›¸ãæ–¹ã‚’ã™ã‚‹ã¨ã€**è½ã¡ã‚‹ã¹ã(èª¤ã£ãŸ)ãƒ†ã‚¹ãƒˆãŒé€šé**ã™ã‚‹å ´åˆãŒã‚ã‚‹ã€‚

## çµè«–

### ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯

- ãƒ†ã‚¹ãƒˆé–¢æ•°ã®å¼•æ•°ã«`done`ã‚’å…¥ã‚Œã‚‹
- ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°å†…ã®æœ€å¾Œã§`done()` ã™ã‚‹

### Promise

- Promise ã‚’`return`ã™ã‚‹ã‹ã€`async` / `await` ã§æ‰±ã†
- ç•°å¸¸ç³»ã®ãƒ†ã‚¹ãƒˆã§ã¯ã€`catch` å¥ã®å¤–å´ã« `expect.assertions(n)` / `expect. hasAssertions()` ã‚’æ›¸ãã‹ã€`expect(Promise).rejects`ã‚’ä½¿ã†

## ãƒªãƒ³ã‚¯

- [Testing Asynchronous Code Â· Jest](https://jestjs.io/docs/ja/asynchronous)
- [jest - Necessary to use expect.assertions() if you're awaiting any async function calls? - Stack Overflow](https://stackoverflow.com/questions/50816254/necessary-to-use-expect-assertions-if-youre-awaiting-any-async-function-calls)

---

## å•é¡Œ

é©åˆ‡ãªæ›¸ãæ–¹ã‚’ã—ãªã‹ã£ãŸå ´åˆã€**éåŒæœŸå‡¦ç†(å†…ã®`expect`)ãŒå®Ÿè¡Œã•ã‚Œã‚‹å‰ã«ãƒ†ã‚¹ãƒˆé–¢æ•°ãŒçµ‚äº†**ã—ã¦ã—ã¾ã†ã€‚
Jest ã¯ãƒ†ã‚¹ãƒˆé–¢æ•°ãŒ(ã‚¨ãƒ©ãƒ¼ãªã)çµ‚äº†ã—ãŸæ™‚ç‚¹ã§é€šéã¨ã¿ãªã™ãŸã‚ã€**èª¤ã£ãŸãƒ†ã‚¹ãƒˆãŒé€šéã¨ã¿ãªã•ã‚Œã‚‹**å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

## ã©ã†ã™ã‚‹ã®ã‹

### (å‰æ) ä»¥ä¸‹ã®ä¾‹ã§æ‰±ã†ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®é–¢æ•°

ã„ãšã‚Œã‚‚ãƒ•ãƒ©ã‚°`isSuccess`ã«å¿œã˜ã¦`'hoge'`ã‹`Error('error!')`ã‚’è¿”ã™ã€‚

#### ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯

```js
const someCallback = (isSuccess, cb) => {
  setTimeout(() => {
    const err = new Error('error!');
    const data = 'data';
    return isSuccess ? cb(null, data) : cb(err, null);
  }, 200);
};
```

#### Promise

```js
const somePromise = isSuccess => {
  return new Promise((resolve, reject) => {
    const err = new Error('error!');
    const data = 'data';
    isSuccess ? resolve(data) : reject(err);
  });
};
```

## âŒ ãªæ›¸ãæ–¹ã¨ â­• ãªæ›¸ãæ–¹

### ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯

âŒ ãƒ†ã‚¹ãƒˆé–¢æ•°ã®å¼•æ•°ã«`done`ã‚’å…¥ã‚Œã¦ã„ãªã„
âŒ ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’`done()`ã§çµ‚ã‚ã‚‰ã›ã¦ã„ãªã„

```js
// pass!
test('no done ', () => {
  someCallback(false, (err, data) => {
    expect(data).toBe('fuga'); // data === hoge
  });
});
```

â­• ãƒ†ã‚¹ãƒˆé–¢æ•°ã®å¼•æ•°ã«`done`ã‚’å…¥ã‚Œã¦ã„ã‚‹
â­• ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’`done()`ã§çµ‚ã‚ã‚‰ã›ã¦ã„ã‚‹

```js
// fail!
test('done exists', done => {
  someCallback(false, (err, data) => {
    expect(data).toBe('fuga');
    done();
  });
});
```

### Promise

#### Promise

âŒ Promise ã‚’`return`ã—ã¦ã„ãªã„

```js
// pass!
test('no return', () => {
  somePromise(false).then(() => {
    expect(data).toBe('fuga');
  });
});
```

â­• Promise ã‚’`return`ã—ã¦ã„ã‚‹

```js
// fail!
test('return exists', () => {
  // error!
  return somePromise(false).then(() => {
    expect(data).toBe('fuga');
  });
});
```

ç›´æ¥é–¢ä¿‚ã¯ãªã„ãŒã€Promise ã¯`resolves`/`rejects`ã‚’ä½¿ã†ã¨ã™ã£ãã‚Šæ›¸ã‘ã‚‹

```js
// fail!
test('resolves 1', () => {
  return expect(somePromise(false)).resolves.toBe('fuga');
});

// pass!
test('resolves 2', () => {
  return expect(somePromise(true)).resolves.toBe('hoge');
});
```

#### `async` / `await`

âŒ `await`ã—ã¦ã„ãªã„

- ã¨ã„ã†ã‹ç´ ã® Promise ã®æ›¸ãæ–¹ã¨ã”ã£ã¡ã‚ƒã«ãªã£ã¦ã„ã‚‹
- (å®Ÿå‹™ã§è¦‹ãŸ)

```js
// pass!
test('no await', async () => {
  somePromise(false).then(result => {
    expect(result).toBe('fuga');
  });
});
```

â­• `await`ã—ã¦ã„ã‚‹

```js
// fail!
test('await exists', async () => {
  const result = await somePromise(false); // error!
  expect(result).toBe('fuga');
});
```

ãªãŠã€`await`ã—å¿˜ã‚ŒãŸã ã‘ãªã‚‰`expect`ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã®ã§è½ã¡ã‚‹

```js
// fail!
test('forgot await', async () => {
  const result = somePromise(false);
  expect(result).toBe('fuga'); // Comparing two different types of values. Expected string but received object.
});
```

### ç•°å¸¸ç³»

`expect`ãŒå®Ÿè¡Œã•ã‚Œãªã„å ´åˆãƒ†ã‚¹ãƒˆãŒ pass ã—ã¦ã—ã¾ã†

âŒ `expect.assertions(n)` ã—ã¦ã„ãªã„

```js
// pass!
test('no expect assertions', () => {
  return somePromise(true).catch(e => {
    expect(e.message).toBe('error!'); // resolveã•ã‚ŒãŸã®ã§catchå¥ã«å…¥ã‚‰ãªã„
  });
});
```

â­• `expect.assertions(n)` ã—ã¦ã„ã‚‹

- ã„ãã¤ã®`expect`ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¹ãã‹ãƒ†ã‚¹ãƒˆã—ã¦ãã‚Œã‚‹
- `expect`ãŒæ¡ä»¶åˆ†å²ã®ä¸­ã«ã‚ã‚‹ãªã‚‰ã°ã€ç•°å¸¸ç³»ã«é™ã‚‰ãšæ›¸ã„ã¦ãŠãã¨å®‰å¿ƒ

```js
// fail!
test('expect assertions exists', () => {
  expect.assertions(1); // Expected one assertion to be called but received zero assertion calls.
  return somePromise(true).catch(e => {
    expect(e.message).toBe('error!');
  });
});
```
- expectã®æ•°ã«èˆˆå‘³ãŒãªã„å ´åˆã€ã€Œå°‘ãªãã¨ã‚‚ã²ã¨ã¤ `expect`ãŒã‚ã‚‹ã€ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ `expect.hasAssertions()` ã‚‚ä½¿ãˆã‚‹
  - ã‚€ã—ã‚ã“ã£ã¡ãŒãƒ¡ã‚¤ãƒ³ã‹

```js
// fail!
test('expect hasAssertions exists', () => {
  expect.hasAssertions();
  return somePromise(true).catch(e => {
    expect(e.message).toBe('error!');
  });
});
```

â­• `rejects`ã‚’ä½¿ã£ã¦ã„ã‚‹

```js
// fail!
test('using rejects', () => {
  // Expected received Promise to reject, instead it resolved to value "hoge"
  return expect(somePromise(true)).rejects.toThrow('error!');
});

// fail!
test('using rejects', async () => {
  // Expected received Promise to reject, instead it resolved to value "hoge"
  await expect(somePromise(true)).rejects.toThrow('error!');
});
```

## ã©ã†ã—ã¦ã“ã†ãªã‚‹ã®

- Node.js ã¯éåŒæœŸå‡¦ç†ã«å·®ã—æ›ã‹ã‚‹ã¨ã€ãã®å‡¦ç†ã‚’ä¸€æ—¦çµ‚äº†ã—ã€å¾Œç¶šå‡¦ç†ã‚’ç¶šè¡Œã™ã‚‹
  - ä¸€æ—¦çµ‚äº†ã—ãŸå‡¦ç†ã¯ã‚­ãƒ¥ãƒ¼ã«ãŸã‚ã‚‰ã‚Œã€ã»ã‹ã®é€šå¸¸ã®åŒæœŸå‡¦ç†ãŒçµ‚ã‚ã£ã¦ã‹ã‚‰å®Ÿè¡Œã•ã‚Œã‚‹
- Jest ã¯ã€ãƒ†ã‚¹ãƒˆé–¢æ•°ãŒã‚¨ãƒ©ãƒ¼ãªãçµ‚äº†ã™ã‚‹ã¨ pass ã¨ã—ã¦æ‰±ã†

éåŒæœŸå‡¦ç†(ã¨ã„ã†ã‹ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—)ã«ã¤ã„ã¦ã¯ã“ã®ã¸ã‚“ã‚’èª­ã‚€ã¨ç†è§£ãŒæ·±ã¾ã‚‹æ°—ãŒã—ã¾ã™ã€‚

- [éåŒæœŸå‡¦ç†ã¨ Promiseï¼ˆDeferredï¼‰ã‚’èƒŒæ™¯ã‹ã‚‰ç†è§£ã—ã‚ˆã† - hifive](https://www.htmlhifive.com/conts/web/view/study-room/async-programming-with-deferred)
- [ä¸¦åˆ—ãƒ¢ãƒ‡ãƒ«ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ— - JavaScript | MDN](https://developer.mozilla.org/ja/docs/Web/JavaScript/EventLoop)
- [ãã†ã ã£ãŸã®ã‹ï¼ ã‚ˆãã‚ã‹ã‚‹ process.nextTick() node.js ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã‚’ç†è§£ã™ã‚‹](https://www.slideshare.net/shigeki_ohtsu/processnext-tick-nodejs?next_slideshow=1)
- [About | Node.js](https://nodejs.org/en/about/)
- [Overview of Blocking vs Non-Blocking | Node.js](https://nodejs.org/ja/docs/guides/blocking-vs-non-blocking/)

## ãŠã‚ã‚Š
ã¿ã‚“ãªã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚„ã‚ã¦Promiseè¿”ã—ã¦ã‚‚ã‚‰ã†ã‚ˆã†ã«ã—ã¦
`async`/`await`ã™ã‚‹ãªã‚Š`resolves`/`rejects`ã™ã‚‹ãªã‚Šã™ã‚‹ã¨
`expect`ãŒé–¢æ•°ã®å¤–ã«å‡ºã¦
å„ªã—ã„ä¸–ç•ŒãŒè¨ªã‚Œã‚‹æ°—ãŒã—ã¾ã™ã€‚
